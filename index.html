<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sorteio Rover em Guerra contra os pre√ßos altos</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link href="https://fonts.googleapis.com/css2?family=Abel:wght@400&family=Manrope:wght@200..800&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --bg: #050505;
      --bg2: #0a0a0a;
      --card: #0d0d0d;
      --card2: #0f0f0f;

      --text: #f6f2ea;
      --muted: rgba(246, 242, 234, .70);
      --muted2: rgba(246, 242, 234, .52);

      --line: rgba(255, 255, 255, .08);
      --line2: rgba(255, 255, 255, .12);

      --gold: #d4af37;
      --gold2: #f0d786;
      --goldSoft: rgba(212, 175, 55, .20);

      --danger: #ff4d5e;

      --shadow: 0 18px 60px rgba(0, 0, 0, .60);
      --shadow2: 0 10px 26px rgba(0, 0, 0, .45);

      --r12: 12px;
      --r16: 16px;
      --r20: 20px;

      --serif: "Abel", sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --ease: cubic-bezier(.2, .9, .2, 1);
      --t150: 150ms;
      --t220: 220ms;
    }

    * {
      box-sizing: border-box;
      font-family: var(--serif);
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: var(--serif);
      color: var(--text);

      background:
        radial-gradient(900px 520px at 50% 0%, rgba(212, 175, 55, .14), transparent 60%),
        radial-gradient(900px 520px at 15% 100%, rgba(212, 175, 55, .08), transparent 65%),
        rgba(0, 0, 0, .92);

      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(0deg,
          rgba(255, 255, 255, .05) 0px,
          rgba(255, 255, 255, .05) 1px,
          transparent 1px,
          transparent 7px);
      opacity: .08;
      pointer-events: none;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      inset: -40%;
      background:
        repeating-linear-gradient(120deg,
          rgba(212, 175, 55, .10) 0px,
          rgba(212, 175, 55, .10) 10px,
          transparent 10px,
          transparent 38px),
        radial-gradient(1200px 700px at 50% 50%, transparent 60%, rgba(0, 0, 0, .65) 100%);
      opacity: .07;
      transform: rotate(-10deg);
      animation: drift 12s linear infinite;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes drift {
      0% {
        transform: translateX(-8%) rotate(-10deg)
      }

      100% {
        transform: translateX(8%) rotate(-10deg)
      }
    }

    .wrap,
    header,
    .grid,
    .modal,
    .overlay,
    .toast,
    svg {
      position: relative;
      z-index: 1;
    }

    body.overlay-open {
      overflow: hidden;
      padding-right: var(--sbw, 0px);
    }

    :focus-visible {
      outline: 2px solid rgba(212, 175, 55, .35);
      outline-offset: 2px;
    }

    body .hairline {
      content: "";
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(212, 175, 55, .35), transparent);
      opacity: .65;
      pointer-events: none;
      z-index: 9990;
    }

    body.overlay-open .wrap {
      filter: saturate(.95) brightness(.80);
      transition: filter var(--t220) ease;
    }

    .wrap {
      max-width: 1800px;
      margin: 0 auto;
      padding: 22px 16px 34px;
      transition: filter var(--t220) ease;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 12px 20px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, .04);

      background: linear-gradient(180deg, rgba(0, 0, 0, .70), rgba(0, 0, 0, .20));
      backdrop-filter: blur(6px);
      border-radius: 20px;
      margin: 1.2rem;
    }

    header::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: -1px;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(212, 175, 55, .28), transparent);
      opacity: .85;
      pointer-events: none;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      min-width: 280px;
      min-height: 52px;
    }

    .logo {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      background: linear-gradient(180deg, #0f0f0f, #090909);
      border: 1px solid var(--line);
      box-shadow: var(--shadow2);
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      user-select: none;
      transition: transform var(--t150) ease, border-color var(--t150) ease;
      flex: 0 0 auto;
    }

    .logo:hover {
      transform: translateY(-1px);
      border-color: rgba(212, 175, 55, .28)
    }

    .logo:active {
      transform: translateY(0px)
    }

    .logo::after {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(212, 175, 55, .45), transparent 45%, rgba(212, 175, 55, .20));
      opacity: .18;
      pointer-events: none;
    }

    .logo span {
      font-family: var(--serif);
      font-weight: 700;
      letter-spacing: .2px;
      line-height: 1.05;
      font-size: 12px;
      color: var(--gold2);
      text-align: center;
      padding: 0 6px;
      position: relative;
      z-index: 2;
    }

    #logoImg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
      z-index: 1;
    }

    .titles {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    h1 {
      margin: 0;
      font-family: var(--serif);
      font-size: 16px;
      font-weight: 700;
      letter-spacing: .2px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: min(560px, 60vw);
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: .18em;
      text-transform: uppercase;
    }

    .rightTop {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      min-width: 320px;
    }

    .metrics {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .metric {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0, 0, 0, .55);
      box-shadow: var(--shadow2);
      white-space: nowrap;
    }

    .metric .k {
      font-size: 10.5px;
      color: var(--muted);
      letter-spacing: .18em;
      text-transform: uppercase;
    }

    .metric .v {
      font-family: var(--serif);
      font-weight: 700;
      font-size: 14px;
      color: var(--gold2);
      letter-spacing: .02em;
    }

    .actionsTop {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 16px;
      margin-top: 12px;
    }

    @media (max-width:980px) {
      .grid {
        grid-template-columns: 1fr
      }

      h1 {
        max-width: 92vw;
      }

      .rightTop {
        min-width: 0;
        width: 100%;
      }
    }

    .card {
      background: linear-gradient(180deg, rgba(13, 13, 13, .92), rgba(7, 7, 7, .92));
      border: 1px solid var(--line);
      border-radius: var(--r20);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-width: 0;
    }

    .card .hd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 16px 16px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      background: linear-gradient(180deg, rgba(212, 175, 55, .05), transparent);
      flex-wrap: wrap;
    }

    .card .hd strong {
      font-family: var(--serif);
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(246, 242, 234, .88);
      white-space: nowrap;
    }

    .card .bd {
      padding: 16px
    }

    .field {
      position: relative
    }

    .field input,
    .field textarea,
    .field select {
      width: 100%;
      background: rgba(0, 0, 0, .55);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 14px;
      padding: 14px 12px 12px;
      font-size: 13px;
      outline: none;
      transition: border-color var(--t150) ease, box-shadow var(--t150) ease, transform var(--t150) ease;
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }

    .field textarea {
      min-height: 140px;
      resize: vertical
    }

    .field .flabel {
      position: absolute;
      left: 12px;
      top: 12px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .02em;
      pointer-events: none;
      transform-origin: left top;
      transition: transform var(--t150) ease, opacity var(--t150) ease, color var(--t150) ease;
      opacity: .95;
    }

    .field input:focus+.flabel,
    .field textarea:focus+.flabel,
    .field select:focus+.flabel,
    .field input:not(:placeholder-shown)+.flabel,
    .field textarea:not(:placeholder-shown)+.flabel {
      transform: translateY(-9px) scale(.88);
      opacity: .85;
      color: rgba(240, 215, 134, .85);
    }

    .field select+.flabel {
      transform: translateY(-9px) scale(.88);
      opacity: .85;
      color: rgba(240, 215, 134, .75);
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus {
      border-color: rgba(212, 175, 55, .45);
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .08);
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.45;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .tight {
      flex: 0 0 auto
    }

    @media (max-width:620px) {
      .row {
        flex-direction: column;
        align-items: stretch
      }

      .tight {
        flex: 1
      }
    }

    /* =========================
       (NEW) BUTTON ANIMATIONS
       ========================= */
    .btn,
    .iconBtn {
      transform: translateZ(0);
      will-change: transform, filter;
    }

    .btn {
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .btn::before {
      content: "";
      position: absolute;
      inset: -1px;
      background:
        radial-gradient(200px 120px at 20% 10%, rgba(240, 215, 134, .25), transparent 60%),
        radial-gradient(200px 120px at 80% 90%, rgba(212, 175, 55, .18), transparent 60%);
      opacity: 0;
      transition: opacity var(--t220) ease;
      pointer-events: none;
      z-index: 0;
    }

    .btn::after {
      content: "";
      position: absolute;
      top: -20%;
      bottom: -20%;
      width: 42%;
      left: -60%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .18), transparent);
      transform: skewX(-18deg);
      opacity: 0;
      pointer-events: none;
      z-index: 0;
    }

    .btn>* {
      position: relative;
      z-index: 1;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn:hover::after {
      opacity: 1;
      animation: sheen 620ms var(--ease) 1;
    }

    @keyframes sheen {
      0% {
        left: -60%;
        opacity: 0;
      }

      15% {
        opacity: 1;
      }

      100% {
        left: 120%;
        opacity: 0;
      }
    }

    .btn:active {
      transform: translateY(1px) scale(.99);
    }

    .btn:not(.ghost):not(.secondary):not(.danger) {
      animation: glowIdle 3.8s ease-in-out infinite;
    }

    @keyframes glowIdle {

      0%,
      100% {
        box-shadow: 0 10px 24px rgba(0, 0, 0, .45);
      }

      50% {
        box-shadow: 0 12px 32px rgba(0, 0, 0, .52), 0 0 0 1px rgba(212, 175, 55, .10);
      }
    }

    .btn.ghost,
    .btn.secondary,
    .btn.danger {
      transition: transform var(--t150) ease, border-color var(--t150) ease, filter var(--t150) ease, box-shadow var(--t150) ease;
    }

    .btn.ghost:hover {
      transform: translateY(-1px);
      border-color: rgba(240, 215, 134, .30);
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .06);
    }

    .btn.secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .06);
    }

    .btn.danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 6px rgba(255, 77, 94, .08);
      border-color: rgba(255, 77, 94, .45);
    }

    .iconBtn {
      position: relative;
      overflow: hidden;
      transition: transform var(--t150) ease, border-color var(--t150) ease, filter var(--t150) ease, box-shadow var(--t150) ease;
    }

    .iconBtn::after {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(140px 80px at 50% 50%, rgba(212, 175, 55, .14), transparent 60%);
      opacity: 0;
      transition: opacity var(--t220) ease;
      pointer-events: none;
    }

    .iconBtn:hover {
      transform: translateY(-1px) scale(1.02);
      filter: brightness(1.06);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .35);
    }

    .iconBtn:hover::after {
      opacity: 1;
    }

    .iconBtn:active {
      transform: translateY(1px) scale(.98);
    }

    @media (prefers-reduced-motion: reduce) {

      .btn,
      .iconBtn,
      .btn::after,
      .btn:not(.ghost):not(.secondary):not(.danger) {
        animation: none !important;
        transition: none !important;
      }
    }

    .btn {
      appearance: none;
      border: none;
      cursor: pointer;
      user-select: none;
      border-radius: 14px;
      padding: 10px 12px;
      min-height: 40px;
      font-family: var(--serif);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .08em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: #0b0b0b;
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      box-shadow: 0 10px 24px rgba(0, 0, 0, .45);
      transition: transform var(--t150) ease, filter var(--t150) ease, box-shadow var(--t150) ease;
      white-space: nowrap;
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .12), 0 10px 24px rgba(0, 0, 0, .45);
    }

    .btn.secondary {
      background: transparent;
      color: var(--gold2);
      border: 1px solid rgba(212, 175, 55, .35);
      box-shadow: none;
      letter-spacing: .06em;
    }

    .btn.ghost {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: none;
      text-transform: none;
      letter-spacing: .02em;
      font-weight: 650;
      animation: none;
    }

    .btn.danger {
      background: transparent;
      color: var(--danger);
      border: 1px solid rgba(255, 77, 94, .28);
      box-shadow: none;
      text-transform: none;
      letter-spacing: .02em;
      font-weight: 750;
      animation: none;
    }

    .icon {
      display: inline-block
    }

    .iconBtn {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: inline-grid;
      place-items: center;
      border: 1px solid rgba(255, 255, 255, .12);
      background: transparent;
      color: rgba(246, 242, 234, .86);
      cursor: pointer;
      flex: 0 0 auto;
    }

    .iconBtn.danger {
      color: var(--danger);
      border-color: rgba(255, 77, 94, .28)
    }

    .iconBtn.danger:hover {
      border-color: rgba(255, 77, 94, .45)
    }

    .iconBtn:focus-visible {
      outline: none;
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .10)
    }

    .list {
      margin-top: 14px;
      border-radius: var(--r16);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .55);
    }

    .listTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, .07);
      background: linear-gradient(180deg, rgba(212, 175, 55, .04), transparent);
    }

    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 9px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, .45);
      border: 1px solid rgba(255, 255, 255, .12);
      min-width: 240px;
      max-width: 52%;
    }

    .search input {
      width: 100%;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 12px;
    }

    @media (max-width:620px) {
      .search {
        min-width: unset;
        max-width: 100%;
      }

      .listTop {
        flex-direction: column;
        align-items: stretch
      }
    }

    .mini {
      font-family: var(--serif);
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212, 175, 55, .22);
      background: rgba(212, 175, 55, .06);
      color: rgba(246, 242, 234, .78);
      white-space: nowrap;
    }

    .scroll {
      max-height: 280px;
      overflow: auto;
      overscroll-behavior: contain;
    }

    .scroll::-webkit-scrollbar {
      height: 10px;
      width: 10px
    }

    .scroll::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, .10);
      border-radius: 999px
    }

    .scroll::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, .03)
    }

    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      transition: transform var(--t150) ease, border-color var(--t150) ease, background var(--t150) ease;
    }

    .item:nth-child(odd) {
      background: rgba(255, 255, 255, .02)
    }

    .item:nth-child(even) {
      background: rgba(255, 255, 255, .01)
    }

    .item:hover {
      transform: translateY(-1px);
      background: rgba(212, 175, 55, .05);
      border-bottom-color: rgba(212, 175, 55, .16);
    }

    .item:last-child {
      border-bottom: none
    }

    .name {
      font-weight: 850;
      font-size: 13px;
      letter-spacing: .01em
    }

    .muted {
      color: var(--muted2);
      font-size: 12px
    }

    .time {
      font-family: var(--serif);
      font-size: 11px;
      color: rgba(246, 242, 234, .74)
    }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .block {
      border-radius: var(--r16);
      border: 1px solid rgba(255, 255, 255, .10);
      background: radial-gradient(520px 240px at 15% 0%, rgba(212, 175, 55, .10), transparent 55%),
        rgba(0, 0, 0, .55);
      padding: 12px;
      min-width: 0;
    }

    /* ============ (NEW) GROUPS UI ============ */
    .groupWrap {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .groupGrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media (min-width:520px) {
      .groupGrid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .gCard {
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .42);
      padding: 10px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      transition: transform var(--t150) ease, border-color var(--t150) ease, background var(--t150) ease;
      cursor: pointer;
      user-select: none;
    }

    .gCard:hover {
      transform: translateY(-1px);
      border-color: rgba(212, 175, 55, .20);
      background: rgba(212, 175, 55, .04);
    }

    .gLeft {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .gCheck {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, .18);
      background: rgba(0, 0, 0, .55);
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    .gCheck i {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: var(--gold2);
      opacity: 0;
      transition: opacity var(--t150) ease;
    }

    .gCard[data-on="1"] .gCheck {
      border-color: rgba(212, 175, 55, .35);
      background: rgba(212, 175, 55, .08);
    }

    .gCard[data-on="1"] .gCheck i {
      opacity: 1;
    }

    .gMeta {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .gTitle {
      font-weight: 850;
      letter-spacing: .02em;
      font-size: 12px;
      text-transform: uppercase;
      color: rgba(246, 242, 234, .92);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .gSub {
      font-size: 12px;
      color: var(--muted2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 46ch;
    }

    .gPill {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212, 175, 55, .22);
      background: rgba(212, 175, 55, .06);
      color: rgba(246, 242, 234, .78);
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .gActions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    }

    .gDivider {
      height: 1px;
      background: rgba(255, 255, 255, .08);
      opacity: .65;
      margin: 2px 0 0;
    }

    .gSummary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }

    .gSummary .mini {
      margin: 0;
    }

    /* =========================
       RIGHT PANEL
       ========================= */
    .spot-inner {
      display: grid;
      grid-template-columns: 52px 1fr auto;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }

    @media (max-width:620px) {
      .spot-inner {
        grid-template-columns: 52px 1fr;
        grid-template-areas: "m c"
          "a a";
      }

      .spot-left {
        grid-area: m
      }

      .spot-right {
        grid-area: c;
        min-width: 0;
      }

      .spot-actions {
        grid-area: a;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: flex-end
      }
    }

    .medal {
      width: 44px;
      height: 44px;
      border-radius: 14px;
      background: linear-gradient(180deg, var(--gold2), var(--gold));
      display: grid;
      place-items: center;
      color: #0b0b0b;
      box-shadow: 0 10px 24px rgba(0, 0, 0, .45);
    }

    .spot-name {
      font-family: var(--serif);
      font-weight: 700;
      font-size: 18px;
      letter-spacing: .2px;
      margin-top: 2px;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .82);
      z-index: 12000;
      padding: 16px;
    }

    .modal[aria-hidden="false"] {
      display: flex
    }

    .modalPanel {
      width: min(660px, 96vw);
      border-radius: var(--r20);
      background: linear-gradient(180deg, #0d0d0d, #070707);
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: var(--shadow);
      overflow: hidden;
      max-height: 92vh;
      display: flex;
      flex-direction: column;
    }

    .modalHd {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 14px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, .06);
      background: linear-gradient(180deg, rgba(212, 175, 55, .06), transparent);
    }

    .modalHd h3 {
      margin: 0;
      font-family: var(--serif);
      font-weight: 700;
      font-size: 16px;
    }

    .modalBody {
      padding: 14px;
      overflow: auto;
    }

    .modalFt {
      padding: 12px 14px;
      border-top: 1px solid rgba(255, 255, 255, .06)
    }

    .kbd {
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .04);
      border: 1px solid rgba(255, 255, 255, .06);
      color: rgba(246, 242, 234, .82);
      display: inline-block;
    }

    .toggleRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(0, 0, 0, .55);
      margin-top: 12px;
    }

    .toggleRow .tmeta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toggleRow .tmeta .ttl {
      font-weight: 750;
      letter-spacing: .02em;
      font-size: 13px;
    }

    .toggleRow .tmeta .sub {
      color: var(--muted2);
      font-size: 12px;
      line-height: 1.35;
    }

    .switch {
      width: 48px;
      height: 28px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .10);
      border: 1px solid rgba(255, 255, 255, .12);
      position: relative;
      cursor: pointer;
      flex: 0 0 auto;
      transition: background var(--t150) ease, border-color var(--t150) ease;
    }

    .switch::after {
      content: "";
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(246, 242, 234, .92);
      transition: transform var(--t150) ease, background var(--t150) ease;
      box-shadow: 0 6px 14px rgba(0, 0, 0, .40);
    }

    .switch.on {
      background: rgba(212, 175, 55, .18);
      border-color: rgba(212, 175, 55, .28);
    }

    .switch.on::after {
      transform: translateX(20px);
      background: var(--gold2);
    }

    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      min-width: 220px;
      max-width: min(420px, 92vw);
      padding: 12px 12px;
      border-radius: 14px;
      background: #0b0b0b;
      border: 1px solid rgba(255, 255, 255, .12);
      color: var(--text);
      box-shadow: var(--shadow2);
      transform: translateY(10px);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--t220) ease, transform var(--t220) ease;
      z-index: 13000;
    }

    .toast.show {
      opacity: 1;
      transform: none
    }

    .toast small {
      display: block;
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px
    }

    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: radial-gradient(900px 520px at 50% 0%, rgba(212, 175, 55, .14), transparent 60%),
        radial-gradient(900px 520px at 15% 100%, rgba(212, 175, 55, .08), transparent 65%),
        rgba(0, 0, 0, .92);
      z-index: 9999;
      overflow: hidden;
      padding: 14px;
    }

    .overlay::before {
      content: "";
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(0deg,
          rgba(255, 255, 255, .05) 0px,
          rgba(255, 255, 255, .05) 1px,
          transparent 1px,
          transparent 7px);
      opacity: .08;
      pointer-events: none;
    }

    .overlay::after {
      content: "";
      position: absolute;
      inset: -40%;
      background: repeating-linear-gradient(120deg,
          rgba(212, 175, 55, .10) 0px,
          rgba(212, 175, 55, .10) 10px,
          transparent 10px,
          transparent 38px);
      opacity: .06;
      transform: rotate(-10deg);
      animation: drift 12s linear infinite;
      pointer-events: none;
    }

    .center {
      width: min(980px, 94vw);
      text-align: center;
      position: relative;
      padding: 22px 16px 18px;
      border-radius: 26px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: linear-gradient(180deg, rgba(13, 13, 13, .98), rgba(7, 7, 7, .96));
      box-shadow: var(--shadow);
      overflow: hidden;
      transform: translateZ(0);
    }

    .center::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(260px 140px at 18% 0%, rgba(212, 175, 55, .20), transparent 60%),
        radial-gradient(260px 140px at 85% 100%, rgba(212, 175, 55, .12), transparent 65%);
      opacity: .9;
      pointer-events: none;
    }

    .headline {
      position: relative;
      font-size: 12px;
      color: rgba(246, 242, 234, .72);
      letter-spacing: .18em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .phase {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(212, 175, 55, .24);
      background: rgba(212, 175, 55, .06);
      color: rgba(246, 242, 234, .88);
      font-family: var(--serif);
      font-size: 11px;
      margin-bottom: 12px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gold2);
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .10);
    }

    .steps {
      position: relative;
      width: min(740px, 92%);
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .10);
      background: rgba(255, 255, 255, .03);
      flex-wrap: wrap;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-family: var(--serif);
      color: rgba(246, 242, 234, .62);
      letter-spacing: .06em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .step .b {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, .12);
      border: 1px solid rgba(255, 255, 255, .12);
    }

    .step.on {
      color: rgba(246, 242, 234, .86)
    }

    .step.on .b {
      background: var(--gold2);
      border-color: rgba(212, 175, 55, .35);
      box-shadow: 0 0 0 6px rgba(212, 175, 55, .10);
    }

    .count {
      font-family: var(--serif);
      font-size: 92px;
      font-weight: 700;
      color: var(--gold2);
      margin: 6px 0 2px;
      position: relative;
      letter-spacing: .02em;
    }

    .bar {
      width: min(560px, 92%);
      height: 10px;
      background: rgba(255, 255, 255, .06);
      border-radius: 999px;
      margin: 12px auto 10px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, .06);
    }

    .fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--gold), var(--gold2));
      transition: width 520ms var(--ease);
    }

    .subline {
      position: relative;
      color: var(--muted);
      font-size: 13px;
      margin: 10px 0 8px;
      letter-spacing: .02em;
    }

    .rolling {
      position: relative;
      font-size: 18px;
      font-weight: 750;
      color: rgba(246, 242, 234, .80);
      margin-top: 8px;
    }

    .final {
      position: relative;
      margin-top: 8px;
    }

    .revealWrap {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      padding: 2px 0;
    }

    .revealItem {
      opacity: 0;
      transform: translateY(10px) scale(.98);
      transition: opacity 320ms ease, transform 360ms var(--ease);
      font-family: var(--serif);
      font-size: 40px;
      font-weight: 700;
      color: var(--gold2);
      letter-spacing: .01em;
      text-shadow: 0 14px 46px rgba(0, 0, 0, .65);
      max-width: 92vw;
      overflow-wrap: anywhere;
    }

    .revealItem.show {
      opacity: 1;
      transform: none;
    }

    .overlayActions {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      position: relative;
    }

    .flash {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: radial-gradient(closest-side at 50% 45%, rgba(212, 175, 55, .20), transparent 58%);
      opacity: 0;
    }

    .flash.on {
      animation: flashBang 260ms ease-out 1
    }

    @keyframes flashBang {
      0% {
        opacity: 0
      }

      20% {
        opacity: 1
      }

      100% {
        opacity: 0
      }
    }

    .tracers {
      position: absolute;
      inset: 0;
      pointer-events: none
    }

    .tracer {
      position: absolute;
      width: 260px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(240, 215, 134, .95), transparent);
      filter: drop-shadow(0 0 10px rgba(212, 175, 55, .18));
      opacity: 0;
    }

    .tracer.t1 {
      top: 22%;
      left: -30%
    }

    .tracer.t2 {
      top: 40%;
      left: -45%
    }

    .tracer.t3 {
      top: 58%;
      left: -40%
    }

    @keyframes tracerFly {
      0% {
        transform: translateX(0) rotate(var(--rot)) scaleX(.95);
        opacity: 0
      }

      12% {
        opacity: .90;
        transform: translateX(12vw) rotate(var(--rot)) scaleX(1)
      }

      100% {
        transform: translateX(180vw) rotate(var(--rot)) scaleX(1.05);
        opacity: 0
      }
    }

    .shake {
      animation: shakeCam 360ms var(--ease) 1
    }

    @keyframes shakeCam {
      0% {
        transform: translate(0, 0)
      }

      15% {
        transform: translate(-6px, 3px)
      }

      35% {
        transform: translate(7px, -4px)
      }

      55% {
        transform: translate(-5px, -2px)
      }

      75% {
        transform: translate(4px, 5px)
      }

      100% {
        transform: translate(0, 0)
      }
    }

    body.stage .wrap {
      max-width: 1280px
    }

    body.stage .subtitle {
      opacity: .90
    }

    body.stage .count {
      font-size: 120px
    }

    body.stage .revealItem {
      font-size: 56px
    }

    body.stage .headline {
      font-size: 13px
    }

    body.stage .center {
      width: min(1180px, 96vw);
      padding: 26px 18px 20px
    }

    body.stage .steps {
      width: min(920px, 94%)
    }

    body.stage .bar {
      width: min(760px, 94%)
    }

    body.stage.overlay-open .wrap {
      opacity: .15;
      filter: none;
      transition: opacity var(--t220) ease;
    }

    @media (max-width:520px) {
      .wrap {
        padding: 18px 12px 26px
      }

      header {
        flex-direction: column;
        align-items: flex-start
      }

      .rightTop {
        width: 100%;
        justify-content: space-between
      }

      .count {
        font-size: 58px
      }

      .revealItem {
        font-size: 28px
      }

      .btn {
        min-height: 46px;
        padding: 12px 14px
      }

      .card .hd {
        flex-direction: column;
        align-items: flex-start
      }

      .actionsTop,
      .card .hd .row {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap
      }

      .metric {
        width: 100%;
        justify-content: space-between
      }

      .metrics {
        width: 100%
      }

      .steps {
        justify-content: center;
      }
    }

    .srOnly {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body class="stage">
  <div class="hairline" aria-hidden="true"></div>

  <svg style="display:none" aria-hidden="true">
    <symbol id="ico-export" viewBox="0 0 24 24">
      <path fill="currentColor" d="M13 3v8h3l-4 5-4-5h3V3h2zM5 19h14v2H5v-2z" />
    </symbol>
    <symbol id="ico-reset" viewBox="0 0 24 24">
      <path fill="currentColor"
        d="M12 6V3L8 7l4 4V8c2.8 0 5 2.2 5 5 0 2.8-2.2 5-5 5s-5-2.2-5-5H5c0 4.4 3.6 8 8 8s8-3.6 8-8c0-4.4-3.6-8-8-8z" />
    </symbol>
    <symbol id="ico-settings" viewBox="0 0 24 24">
      <path fill="currentColor"
        d="M19.4 12.9c.04-.3.06-.6.06-.9s-.02-.6-.06-.9l2.1-1.6c.19-.15.24-.42.12-.64l-2-3.4c-.12-.22-.37-.3-.6-.22l-2.5 1a7.9 7.9 0 0 0-1.6-.9l-.38-2.65A.48.48 0 0 0 13.5 2h-3c-.25 0-.46.18-.49.43l-.38 2.65c-.56.22-1.08.5-1.6.9l-2.5-1a.5.5 0 0 0-.6.22l-2 3.4c-.12.22-.07.49.12.64L4.5 11c-.04.3-.06.6-.06.9s.02.6.06.9L2.4 14.4c-.19.15-.24.42-.12.64l2 3.4c.12.22.37.3.6.22l2.5-1c.5.4 1.04.73 1.6.95l.38 2.65c.03.25.24.43.49.43h3c.25 0 .46-.18.49-.43l.38-2.65c.56-.22 1.08-.5 1.6-.95l2.5 1c.23.09.48 0 .6-.22l2-3.4c.12-.22.07-.49-.12-.64L19.4 12.9zM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7z" />
    </symbol>
    <symbol id="ico-medal" viewBox="0 0 24 24">
      <path fill="currentColor" d="M12 2l2 5 5 .5-3.8 3 1 5-4.2-2.5L7 15l1-5L4 7.5 9 7 12 2z" />
    </symbol>
    <symbol id="ico-trash" viewBox="0 0 24 24">
      <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 7h2v9h-2v-9zm4 0h2v9h-2v-9zM7 8h10l-1 13H8L7 8z" />
    </symbol>
  </svg>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" id="logoBox" title="Clique para enviar sua logo">
          <span id="logoText">ROVER<br>EM GUERRA</span>
          <img id="logoImg" alt="Logo" />
          <input id="logoInput" type="file" accept="image/*" style="display:none" />
        </div>

        <div class="titles">
          <h1 title="Sorteio Rover em Guerra contra os pre√ßos altos">P√ÅGINA DE SORTEIO</h1>
          <div class="subtitle">CAMPANHA ROVER EM GUERRA CONTRA OS PRE√áOS ALTOS</div>
        </div>
      </div>

      <div class="rightTop">
        <div class="srOnly" id="pillStats" aria-live="polite">0 na lista ‚Ä¢ 0 sorteados</div>

        <div class="metrics" aria-label="Indicadores">
          <div class="metric" title="Quantidade de participantes na lista">
            <span class="k">Participantes</span>
            <span class="v" id="metricNames">0</span>
          </div>
          <div class="metric" title="Quantidade de vencedores confirmados">
            <span class="k">Sorteados</span>
            <span class="v" id="metricWinners">0</span>
          </div>
        </div>

        <div class="actionsTop">
          <button class="btn ghost" id="btnExport" title="Exportar vencedores" aria-label="Exportar vencedores">
            <svg class="icon" width="16" height="16">
              <use href="#ico-export"></use>
            </svg>
            CSV
          </button>
          <button class="btn ghost" id="btnExportJson" title="Exportar JSON" aria-label="Exportar JSON">
            <svg class="icon" width="16" height="16">
              <use href="#ico-export"></use>
            </svg>
            JSON
          </button>
          <button class="btn ghost" id="btnSettings" title="Configura√ß√µes" aria-label="Configura√ß√µes">
            <svg class="icon" width="16" height="16">
              <use href="#ico-settings"></use>
            </svg>
          </button>
          <button class="btn danger" id="btnReset" title="Zerar tudo" aria-label="Zerar tudo">
            <svg class="icon" width="16" height="16">
              <use href="#ico-reset"></use>
            </svg>
            Zerar
          </button>
        </div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="hd">
          <strong>Adicionar nomes</strong>
          <div class="row" style="gap:8px;justify-content:flex-end">
            <button class="btn ghost" id="btnImportTxt">Importar .txt</button>
            <button class="btn ghost" id="btnImportJson">Importar JSON</button>
            <button class="btn" id="btnAdd">Adicionar</button>
          </div>
        </div>

        <div class="bd">

          <!-- ============ (NEW) GRUPOS DE PARTICIPANTES ============ -->
          <div class="block" style="margin-bottom:12px;">
            <div class="groupWrap">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">
                <strong
                  style="text-transform:uppercase;letter-spacing:.18em;font-size:10.5px;color:rgba(246,242,234,.86)">
                  Grupos de participantes
                </strong>
                <span class="mini" id="groupsMini">0 selecionado(s)</span>
              </div>

              <div class="gDivider"></div>

              <div class="groupGrid" id="groupsGrid"></div>

              <div class="gSummary">
                <span class="muted" id="groupsInfo">Selecione 1 ou mais grupos para carregar na lista do sorteio.</span>
                <div class="gActions">
                  <button class="btn ghost" id="btnGroupsSelectAll">Selecionar todos</button>
                  <button class="btn ghost" id="btnGroupsClear">Limpar sele√ß√£o</button>
                  <button class="btn ghost" id="btnGroupsAdd">Adicionar grupos</button>
                  <button class="btn" id="btnGroupsReplace">Carregar grupos</button>
                </div>
              </div>

              <div class="hint" style="margin-top:8px">
                ‚ÄúCarregar grupos‚Äù substitui a lista atual. ‚ÄúAdicionar grupos‚Äù s√≥ mescla. Duplicados s√£o removidos
                automaticamente (inclusive entre grupos).
              </div>
            </div>
          </div>
          <!-- ====================================================== -->

          <div class="field">
            <textarea id="namesBox" placeholder=" "></textarea>
            <span class="flabel">Cole os nomes (1 por linha)</span>
          </div>
          <div class="hint">Duplicados s√£o ignorados automaticamente.</div>

          <div style="height:12px"></div>

          <div class="row">
            <div style="flex:1">
              <div class="field">
                <input id="quickAdd" type="text" placeholder=" " />
                <span class="flabel">Adicionar um nome r√°pido (Enter)</span>
              </div>
            </div>
            <div class="tight">
              <button class="btn ghost" id="btnClearInput" title="Limpar a caixa de nomes colados">Limpar caixa</button>
            </div>
          </div>

          <div class="list">
            <div class="listTop">
              <div class="search">üîé <input id="search" placeholder="Buscar nome..." /></div>
              <span class="mini" id="miniInfo">Sem vencedor ainda</span>
            </div>
            <div class="scroll" id="listScroll"></div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="hd">
          <strong>Painel do sorteio</strong>
          <div class="row" style="gap:8px;justify-content:flex-end">
            <button class="btn" id="btnDraw">SORTEAR</button>
            <button class="btn ghost" id="btnUndo">Desfazer</button>
          </div>
        </div>

        <div class="bd">
          <div class="stack">
            <div class="block">
              <div class="field">
                <input id="prize" type="text" placeholder=" " style="margin-top: 25px;" />
                <span class="flabel" style="font-size: 16px;">Pr√™mio (opcional)</span>
              </div>
              <div class="hint">Este texto aparece na tela durante o an√∫ncio.</div>
            </div>

            <div class="block" aria-live="polite">
              <div class="spot-inner">
                <div class="spot-left">
                  <div class="medal">
                    <svg width="24" height="24">
                      <use href="#ico-medal" />
                    </svg>
                  </div>
                </div>
                <div class="spot-right">
                  <div class="muted" style="text-transform:uppercase;letter-spacing:.18em;font-size:10.5px">√öltimo
                    vencedor</div>
                  <div id="lastWinner" class="spot-name">‚Äî</div>
                  <div class="muted" id="lastMeta" style="margin-top:6px;font-family:var(--serif);font-size:12px">Pronto
                    para sortear.</div>
                </div>
                <div class="spot-actions" style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap">
                  <button class="btn ghost" id="btnRepeat">Repetir som</button>
                  <button class="btn ghost" id="btnAnnounce">Anunciar</button>
                </div>
              </div>
            </div>

            <div class="block" style="padding:0">
              <div class="listTop"
                style="border-bottom:1px solid rgba(255,255,255,.07); background:transparent; padding:12px 12px">
                <strong
                  style="text-transform:uppercase;letter-spacing:.18em;font-size:10.5px;color:rgba(246,242,234,.86)">Hist√≥rico</strong>
                <button class="btn ghost" id="btnClearHistory"
                  style="padding:8px 10px;border-radius:12px">Limpar</button>
              </div>
              <div class="scroll" id="historyScroll" style="max-height:260px; padding: 0 0 6px"></div>
            </div>

            <div class="hint">
              Atalhos: <span class="kbd">Espa√ßo</span> sortear ‚Ä¢ <span class="kbd">Enter</span> confirmar ‚Ä¢ <span
                class="kbd">Esc</span> fechar
              <br />Dica: o som pode exigir 1 clique do usu√°rio antes (regra do navegador).
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true"
    aria-labelledby="settingsTitle">
    <div class="modalPanel">
      <div class="modalHd">
        <h3 id="settingsTitle">Configura√ß√µes do Sorteio</h3>
        <button class="btn ghost" id="btnCloseSettings" aria-label="Fechar configura√ß√µes">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <input id="cfgCount" type="number" min="1" max="30" value="5" placeholder=" " />
          <span class="flabel">Contagem (segundos)</span>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <select id="cfgSound">
            <option value="1">Sim</option>
            <option value="0">N√£o</option>
          </select>
          <span class="flabel">Habilitar som</span>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <select id="cfgTheme">
            <option value="gold">Dourado</option>
            <option value="dark">Escuro</option>
          </select>
          <span class="flabel">Tema</span>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <input id="cfgStagger" type="number" min="100" max="3000" value="800" placeholder=" " />
          <span class="flabel">Intervalo entre reveals (ms)</span>
        </div>

        <div style="height:12px"></div>

        <div class="field">
          <input id="cfgVolume" type="number" min="0" max="100" value="100" placeholder=" " />
          <span class="flabel">Volume (0-100)</span>
        </div>

        <div class="toggleRow" style="margin-top:14px">
          <div class="tmeta">
            <div class="ttl">Modo Tel√£o</div>
            <div class="sub">Aumenta tipografia do an√∫ncio e reduz elementos do fundo durante o sorteio.</div>
          </div>
          <div class="switch on" id="cfgStageSwitch" role="switch" aria-checked="true" tabindex="0"
            title="Ativar/Desativar Modo Tel√£o"></div>
        </div>
      </div>

      <div class="modalFt" style="text-align:right">
        <button class="btn ghost" id="btnCancelSettings">Cancelar</button>
        <button class="btn" id="btnSaveSettings">Salvar</button>
      </div>
    </div>
  </div>

  <!-- CINEMA OVERLAY -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="An√∫ncio do sorteio">
    <div class="flash" id="flash"></div>

    <div class="tracers" id="tracers">
      <div class="tracer t1" style="--rot:-14deg"></div>
      <div class="tracer t2" style="--rot:-8deg"></div>
      <div class="tracer t3" style="--rot:-18deg"></div>
    </div>

    <div class="center" id="cinemaCenter" tabindex="-1">
      <div class="headline">OPERA√á√ÉO: SORTEIO ‚Ä¢ SISTEMA DE SELE√á√ÉO ATIVO</div>

      <div class="phase" id="phasePill"><span class="dot"></span><span id="phaseText">PREP</span></div>

      <div class="steps" aria-label="Etapas do sorteio">
        <div class="step" data-step="PREP"><span class="b"></span>Prep</div>
        <div class="step" data-step="COUNTDOWN"><span class="b"></span>Countdown</div>
        <div class="step" data-step="HOLD"><span class="b"></span>Hold</div>
        <div class="step" data-step="REVEAL"><span class="b"></span>Reveal</div>
        <div class="step" data-step="CONFIRM"><span class="b"></span>Confirm</div>
      </div>

      <div class="count" id="count">5</div>
      <div class="bar">
        <div class="fill" id="fill"></div>
      </div>

      <div class="subline" id="subline">Carregando alvo‚Ä¶</div>

      <div class="rolling" id="rolling">‚Äî</div>
      <div class="final" id="finalWinner">‚Äî</div>

      <div class="subline" id="prizeLine" style="margin-top:10px;display:none"></div>

      <div class="overlayActions">
        <button class="btn ghost" id="btnCloseOverlay">Fechar</button>
        <button class="btn" id="btnConfirm">Confirmar vencedor</button>
      </div>

      <div class="subline" style="margin-top:12px">
        <span class="kbd">Esc</span> fecha ‚Ä¢ <span class="kbd">Enter</span> confirma
      </div>
    </div>
  </div>

  <div class="toast" id="toast" aria-live="polite"></div>
  <input id="txtInput" type="file" accept=".txt,text/plain" style="display:none" />
  <input id="jsonInput" type="file" accept="application/json, .json" style="display:none" />

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      // --- STATE ---
      const KEY = "rover_war_cinema_raffle_v1";
      let names = [];
      let winners = [];
      let lastUndo = null;
      let pendingWinner = null;
      let audioUnlocked = false;

      // --- ELEMENTS ---
      const namesBox = $("namesBox");
      const quickAdd = $("quickAdd");
      const search = $("search");
      const listScroll = $("listScroll");
      const historyScroll = $("historyScroll");
      const pillStats = $("pillStats");
      const metricNames = $("metricNames");
      const metricWinners = $("metricWinners");
      const miniInfo = $("miniInfo");
      const prize = $("prize");
      const lastWinner = $("lastWinner");
      const lastMeta = $("lastMeta");

      const overlay = $("overlay");
      const countEl = $("count");
      const rollingEl = $("rolling");
      const finalWinnerEl = $("finalWinner");
      const subline = $("subline");
      const fill = $("fill");
      const phaseText = $("phaseText");
      const prizeLine = $("prizeLine");

      const toast = $("toast");

      const stepEls = Array.from(document.querySelectorAll('.step[data-step]'));

      const logoBox = $("logoBox");
      const logoInput = $("logoInput");
      const logoImg = $("logoImg");
      const logoText = $("logoText");

      const flashEl = $("flash");
      const cinemaCenter = $("cinemaCenter");
      const tracers = document.querySelectorAll(".tracer");

      // --- GROUP UI ELEMENTS ---
      const groupsGrid = $("groupsGrid");
      const groupsMini = $("groupsMini");
      const groupsInfo = $("groupsInfo");
      const btnGroupsSelectAll = $("btnGroupsSelectAll");
      const btnGroupsClear = $("btnGroupsClear");
      const btnGroupsAdd = $("btnGroupsAdd");
      const btnGroupsReplace = $("btnGroupsReplace");

      // --- HELPERS ---
      const nowISO = () => new Date().toISOString();
      const formatBR = (iso) => new Date(iso).toLocaleString("pt-BR", { hour12: false });

      const norm = (s) => (s || "").replace(/\s+/g, " ").trim();
      const stripDiacritics = (s) => String(s || "").normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const keyName = (s) => stripDiacritics(norm(s)).toLowerCase();

      function setScrollbarWidthVar() {
        const sbw = window.innerWidth - document.documentElement.clientWidth;
        document.documentElement.style.setProperty('--sbw', sbw + 'px');
      }
      setScrollbarWidthVar();
      window.addEventListener('resize', setScrollbarWidthVar);

      function showToast(msg, sub = "") {
        toast.innerHTML = msg + (sub ? `<small>${sub}</small>` : "");
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2500);
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
      }
      function escapeAttr(s) { return String(s).replaceAll('"', "&quot;"); }

      function persist() {
        let payload = { names, winners, prize: prize.value, logo: null, cfg: null };
        try {
          const raw = localStorage.getItem(KEY);
          const old = raw ? JSON.parse(raw) : {};
          payload.logo = old.logo || null;

          payload.cfg = { count: 5, sound: true, theme: 'gold', stagger: 800, volume: 100, stage: true };
        } catch { }
        localStorage.setItem(KEY, JSON.stringify(payload));
      }

      function applyStageMode(on) {
        document.body.classList.add('stage');
      }

      function restore() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return;
          const data = JSON.parse(raw);
          names = Array.isArray(data.names) ? data.names : [];
          winners = Array.isArray(data.winners) ? data.winners : [];
          prize.value = data.prize || "";
          if (data.logo) {
            logoImg.src = data.logo;
            logoImg.style.display = "block";
            logoText.style.display = "none";
          }
          applyStageMode(true);
        } catch { }
      }

      function uniqueMerge(list) {
        const set = new Set(names.map(n => keyName(n)));
        let add = 0, dup = 0;
        for (const raw of list) {
          const n = norm(raw);
          if (!n) continue;
          const k = keyName(n);
          if (set.has(k)) { dup++; continue; }
          set.add(k);
          names.push(n);
          add++;
        }
        return { add, dup };
      }

      // =========================
      // GROUPS DATA (dedupe + geral sem vendedores)
      // =========================
      const GROUPS_RAW = {
        vendedores: [
          "CLAUDIAMAR PAIXAO",
          "VALCIR TRINDADE",
          "PEDRO AZEVEDO",
          "ANDRE JUNIOR DE SOUZA",
          "ADRIANO JOSE SETTI RIBAS",
          "FRANCISCO JOCELINO DA SILVA",
          "EDSON LEITE DA SILVA",
          "REGINALDO APARECIDO DE ALMEIDA",
          "DENISSON ALVES DA SILVEIRA",
          "MILTON RAMOS MARINHO",
          "ROBSON GUEDES BATISTA",
          "EDUARDO MEDRADES DE SOUZA",
          "MARCIA SENA",
          "VOLNEY MACHADO",
          "EVERTON CESAR LEVINSKI",
          "FABIANO BATISTA DOS SANTOS",
          "ADEMILSON ALVES",
          "GABRIEL GOMES DE MACEDO"
        ],
        geral: [
          "ALYSON DHEEP OLIVEIRA ROVER",
          "ANDREIA FERREIRA DA SILVA",
          "ANIBAL SOUZA DE CASTRO",
          "ARIELLY MICAELY LUIZ PEREIRA",
          "ALAN CRISTHIAN PEREIRA DA SILVA",
          "BRUNA DE ASSIS PESSOA",
          "CAMILA ISAQUEL BATISTELLA",
          "CRISTIANE GUADY DE OLIVEIRA",
          "EDVAN DA SILVA PROTASIO",
          "EDUARDO ALVES DE SOUZA SILVA",
          "EDVANDERLAN XAVIER PEREIRA DA SILVA",
          "EIDER TALEVI",
          "EMERSON IGOR BARBOSA DE FREITAS",
          "ERILEZIO MOURA PEREIRA",
          "ERLI DA SILVA SOUZA",
          "FLAVIO SANTOS DA SILVA",
          "GABRIEL LEONARDO PERPETUO DA LUZ",
          "JEFERSON ALEM√ÉO DA SILVA",
          "JESSICA GEANE PERES DE SOUZA",
          "JOSE FERNANDES NOGUEIRA",
          "JOSEFINA ROVER SOARES",
          "JULIA SILVA PEREIRA",
          "KLEBER ROVER SOARES",
          "LENIN ASSIS DE ASTRE JUNIOR",
          "LETHANYARRE DE ANDRADE CAMPOS",
          "LUZIANE ARAUJO DA GAMA",
          "LUCAS DA SILVA SIM√ÉO",
          "MARCOS ANTONIO MATOS DE SOUZA",
          "MARIA EDUARDA DE OLIVEIRA BRITO",
          "ODERLEY OLIVEIRA NASCIMENTO",
          "PALOMA CORREA DA SILVA PEREIRA",
          "PATRICIO MORAES DE ANDRADE",
          "RADRIEL DURVAL PEREIRA DE SOUZA",
          "ROSELI APARECIDA FONSECA",
          "RYAN HUGO SOUSA DA SILVA",
          "SARA RAIANE SILVA REIS",
          "SIMONE FERREIRA MENDON√áA CALIXTO",
          "TABATA ROVER DA SILVA",
          "TELMA NUNES DA SILVA",
          "VICTOR SAID VARGAS AYALA",
          "VERA LUCIA LIMA RODRIGUES",
          "VITOR GABRIEL TEIXEIRA MARI",
          "ADILSON FONSECA",
          "ARINEIA DE OLIVEIRA FREITAS",
          "CLEVERSON APARECIDO VANZELLA",
          "CLOVIS CONTADINI FILHO",
          "DANIEL GOMES",
          "DIEUMIKA PRECOIT",
          "EMERSON DO CARMO LIMA",
          "EDINALDO ARAUJO",
          "EZEQUIAS MAGALHAES SALES",
          "FRANCINEY NOGUEIRA MAIA",
          "GABRIEL SARRADO DA SILVA",
          "GLADSON DA CRUZ LIMA",
          "HAROLDO ROMARCIO ANDRADE SILVA",
          "IDIVAN NUNES MARQUES",
          "LAURINDO ROCHA BATISTA",
          "MOACIR ROCHA JUNIOR",
          "RENATO STARK",
          "ROBERTO CARLOS MENDES LOBATO",
          "TIAGO VIEIRA GUEDES",
          "VANDRO DOS SANTOS",
          "WEMERSON FERREIRA ALVES"
        ]
      };

      function uniqList(list) {
        const out = [];
        const set = new Set();
        for (const raw of list || []) {
          const n = norm(raw);
          if (!n) continue;
          const k = keyName(n);
          if (set.has(k)) continue;
          set.add(k);
          out.push(n);
        }
        return out;
      }

      const GROUPS = (() => {
        const sellers = uniqList(GROUPS_RAW.vendedores);
        const sellerKeys = new Set(sellers.map(keyName));

        // garante "geral sem vendedores" de forma robusta
        const generalPre = uniqList(GROUPS_RAW.geral);
        const general = generalPre.filter(n => !sellerKeys.has(keyName(n)));

        return {
          vendedores: { id: "vendedores", title: "Vendedores", desc: "Equipe de vendas", list: sellers },
          geral: { id: "geral", title: "Geral", desc: "Participantes gerais (sem vendedores)", list: general }
        };
      })();

      const selectedGroups = new Set(); // ids selecionados

      function getSelectedGroupIds() {
        return Array.from(selectedGroups.values());
      }

      function selectedPeople() {
        const ids = getSelectedGroupIds();
        const agg = [];
        for (const id of ids) {
          const g = GROUPS[id];
          if (!g) continue;
          agg.push(...g.list);
        }
        // remove duplicidade entre grupos
        return uniqList(agg);
      }

      function updateGroupsMini() {
        const ids = getSelectedGroupIds();
        groupsMini.textContent = `${ids.length} selecionado(s)`;
        if (!ids.length) {
          groupsInfo.textContent = "Selecione 1 ou mais grupos para carregar na lista do sorteio.";
          return;
        }
        const count = selectedPeople().length;
        const label = ids.map(id => GROUPS[id]?.title).filter(Boolean).join(" + ");
        groupsInfo.textContent = `${label}: ${count} participante(s) √∫nicos.`;
      }

      function renderGroupsUI() {
        if (!groupsGrid) return;
        groupsGrid.innerHTML = "";
        Object.values(GROUPS).forEach(g => {
          const on = selectedGroups.has(g.id) ? "1" : "0";
          const el = document.createElement("div");
          el.className = "gCard";
          el.setAttribute("role", "button");
          el.setAttribute("tabindex", "0");
          el.setAttribute("data-id", g.id);
          el.setAttribute("data-on", on);
          el.setAttribute("aria-pressed", selectedGroups.has(g.id) ? "true" : "false");
          el.title = "Clique para selecionar";

          el.innerHTML = `
            <div class="gLeft">
              <div class="gCheck" aria-hidden="true"><i></i></div>
              <div class="gMeta">
                <div class="gTitle">${escapeHtml(g.title)}</div>
                <div class="gSub">${escapeHtml(g.desc)}</div>
              </div>
            </div>
            <div class="gPill">${g.list.length} nomes</div>
          `;

          function toggle() {
            if (selectedGroups.has(g.id)) selectedGroups.delete(g.id);
            else selectedGroups.add(g.id);
            renderGroupsUI();
            updateGroupsMini();
          }

          el.addEventListener("click", toggle);
          el.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
          });

          groupsGrid.appendChild(el);
        });

        updateGroupsMini();
      }

      // =========================
      // RENDER
      // =========================
      function render() {
        pillStats.textContent = `${names.length} na lista ‚Ä¢ ${winners.length} sorteados`;

        if (metricNames) metricNames.textContent = String(names.length);
        if (metricWinners) metricWinners.textContent = String(winners.length);

        miniInfo.textContent = winners.length ? `√öltimo: ${winners[0].name}` : "Sem vencedor ainda";

        const q = norm(search.value).toLowerCase();
        const filtered = names.filter(n => !q || n.toLowerCase().includes(q));
        listScroll.innerHTML = filtered.length ? "" : `<div class="item"><div class="muted">Nenhum nome na lista.</div></div>`;
        filtered.forEach((n) => {
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div style="min-width:0">
              <div class="name">${escapeHtml(n)}</div>
              <div class="muted">participante ativo</div>
            </div>
            <button class="iconBtn danger" data-del="${escapeAttr(n)}" title="Remover ${escapeAttr(n)}" aria-label="Remover">
              <svg width="18" height="18" aria-hidden="true"><use href="#ico-trash"></use></svg>
            </button>
          `;
          listScroll.appendChild(row);
        });

        historyScroll.innerHTML = winners.length ? "" : `<div class="item"><div class="muted">Sem hist√≥rico ainda.</div></div>`;
        winners.forEach((w, i) => {
          const row = document.createElement("div");
          row.className = "item";
          row.innerHTML = `
            <div style="min-width:0">
              <div class="name">${i + 1}. ${escapeHtml(w.name)}</div>
              <div class="time">${escapeHtml(w.prize || "‚Äî")} ‚Ä¢ ${formatBR(w.whenISO)}</div>
            </div>
          `;
          historyScroll.appendChild(row);
        });

        if (winners.length) {
          lastWinner.textContent = winners[0].name;
          lastMeta.textContent = `${winners[0].prize || "‚Äî"} ‚Ä¢ ${formatBR(winners[0].whenISO)}`;
        } else {
          lastWinner.textContent = "‚Äî";
          lastMeta.textContent = "Pronto para sortear.";
        }
      }

      // =========================
      // FX
      // =========================
      function fireTracers() {
        tracers.forEach((t, i) => {
          t.style.animation = "none";
          t.offsetHeight;
          const delay = i * 120;
          t.style.animation = `tracerFly 520ms linear ${delay}ms 1`;
          t.style.opacity = "1";
        });
      }
      function flashBang() {
        if (!flashEl) return;
        flashEl.classList.remove("on");
        flashEl.offsetHeight;
        flashEl.classList.add("on");
      }
      function shake() {
        if (!cinemaCenter) return;
        cinemaCenter.classList.remove("shake");
        cinemaCenter.offsetHeight;
        cinemaCenter.classList.add("shake");
      }

      // --- AUDIO via WebAudio ---
      let ctx = null, master = null;

      function unlockAudio() {
        if (audioUnlocked) return;
        try {
          ctx = new (window.AudioContext || window.webkitAudioContext)();
          master = ctx.createGain();

          master.gain.value = 1;

          try { window.ctx = ctx; window.master = master; } catch { }
          master.connect(ctx.destination);

          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine"; o.frequency.value = 220;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(master);
          o.start();
          o.stop(ctx.currentTime + 0.02);

          master.gain.value = 1;

          audioUnlocked = true;
        } catch {
          audioUnlocked = false;
        }
      }

      try { window.unlockAudio = unlockAudio; window.ensureAudio = unlockAudio; } catch { }

      function tone(freq, dur = 0.12, type = "sine", vol = 0.08) {
        if (!ctx || !audioUnlocked) return;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type;
        o.frequency.value = freq;
        const t0 = ctx.currentTime;
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(Math.max(0.0002, vol), t0 + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
        o.connect(g); g.connect(master);
        o.start(t0);
        o.stop(t0 + dur + 0.01);
      }
      try { window.__tone = tone; } catch { }

      function whoosh(dur = 0.55) {
        if (!ctx || !audioUnlocked) return;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sawtooth";
        const t0 = ctx.currentTime;
        o.frequency.setValueAtTime(55, t0);
        o.frequency.exponentialRampToValueAtTime(95, t0 + dur);
        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(0.06, t0 + 0.10);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);
        o.connect(g); g.connect(master);
        o.start(t0);
        o.stop(t0 + dur + 0.02);
      }

      function tickBeep(step) {
        const base = 540 + (5 - step) * 40;
        tone(base, 0.10, "triangle", 0.08);
        tone(base * 1.5, 0.06, "sine", 0.03);
      }

      function holdHit() {
        tone(110, 0.18, "sine", 0.10);
        tone(880, 0.08, "triangle", 0.06);
      }

      function revealHit() {
        tone(1320, 0.10, "triangle", 0.09);
        tone(660, 0.12, "sine", 0.07);
        whoosh(0.35);
      }

      // =========================
      // GROUP ACTIONS
      // =========================
      function loadGroupsIntoList(mode /* 'replace' | 'add' */) {
        unlockAudio();
        const people = selectedPeople();
        if (!people.length) {
          showToast("Nenhum grupo selecionado.", "Selecione ao menos 1 grupo.");
          return;
        }

        if (mode === "replace") {
          names = []; // zera lista e carrega do zero
          const { add } = uniqueMerge(people);
          persist(); render();
          showToast("Lista carregada.", `${add} participantes no sorteio.`);
        } else {
          const { add, dup } = uniqueMerge(people);
          persist(); render();
          showToast("Grupos adicionados.", `${add} adicionados ‚Ä¢ ${dup} j√° existiam`);
        }
      }

      btnGroupsSelectAll?.addEventListener("click", () => {
        Object.keys(GROUPS).forEach(id => selectedGroups.add(id));
        renderGroupsUI();
      });
      btnGroupsClear?.addEventListener("click", () => {
        selectedGroups.clear();
        renderGroupsUI();
      });
      btnGroupsAdd?.addEventListener("click", () => loadGroupsIntoList("add"));
      btnGroupsReplace?.addEventListener("click", () => loadGroupsIntoList("replace"));

      // --- ADD NAMES ---
      $("btnAdd").addEventListener("click", () => {
        unlockAudio();
        const list = namesBox.value.split(/\r?\n/);
        const { add, dup } = uniqueMerge(list);
        namesBox.value = "";
        persist(); render();
        showToast("Lista atualizada.", `${add} adicionados ‚Ä¢ ${dup} duplicados ignorados`);
      });

      $("btnClearInput").addEventListener("click", () => namesBox.value = "");

      quickAdd.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          unlockAudio();
          const v = norm(quickAdd.value);
          if (!v) return;
          const { add } = uniqueMerge([v]);
          quickAdd.value = "";
          persist(); render();
          showToast(add ? "Adicionado." : "J√° existia.", v);
        }
      });

      listScroll.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-del]");
        if (!btn) return;
        const n = btn.getAttribute("data-del");
        const idx = names.findIndex(x => x === n);
        if (idx >= 0) {
          names.splice(idx, 1);
          persist(); render();
          showToast("Removido.", n);
        }
      });

      search.addEventListener("input", render);

      // --- IMPORT TXT ---
      const txtInput = $("txtInput");
      $("btnImportTxt").addEventListener("click", () => { unlockAudio(); txtInput.click(); });
      txtInput.addEventListener("change", async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        unlockAudio();
        const text = await file.text();
        const list = text.split(/\r?\n/);
        const { add, dup } = uniqueMerge(list);
        txtInput.value = "";
        persist(); render();
        showToast("Importado.", `${add} adicionados ‚Ä¢ ${dup} duplicados ignorados`);
      });

      // --- CINEMA DRAW FLOW ---
      function pickRandom() {
        const idx = Math.floor(Math.random() * names.length);
        return { name: names[idx], idx };
      }

      let ticker = null, countdown = null, flowTimer = null;

      function setPhase(text) {
        phaseText.textContent = text;
        stepEls.forEach(el => el.classList.toggle('on', el.dataset.step === text));
      }

      function openOverlay() {
        document.body.classList.add('overlay-open');
        overlay.style.display = "flex";

        setTimeout(() => cinemaCenter?.focus(), 0);

        finalWinnerEl.style.display = "none";
        rollingEl.style.display = "block";
        fill.style.width = "0%";
        setPhase("PREP");
        subline.textContent = "Carregando alvo‚Ä¶";
        pendingWinner = null;

        const cfg = readConfig();
        countEl.textContent = String(Number(cfg.count) || 5);

        const pv = norm(prize.value);
        if (pv) {
          prizeLine.style.display = "block";
          prizeLine.textContent = "PR√äMIO: " + pv;
        } else {
          prizeLine.style.display = "none";
          prizeLine.textContent = "";
        }
      }

      function stopAll() {
        if (ticker) { clearInterval(ticker); ticker = null; }
        if (countdown) { clearInterval(countdown); countdown = null; }
        if (flowTimer) { clearTimeout(flowTimer); flowTimer = null; }
      }

      function closeOverlay() {
        overlay.style.display = "none";
        document.body.classList.remove('overlay-open');
        stopAll();
      }

      function startRolling() {
        ticker = setInterval(() => {
          if (!names.length) return;
          rollingEl.textContent = pickRandom().name;
        }, 55);
      }

      function stopRolling() {
        if (ticker) { clearInterval(ticker); ticker = null; }
      }

      function readConfig() {
        return { count: 5, sound: true, theme: 'gold', stagger: 800, volume: 100, stage: true };
      }

      function speak(text) {
        try {
          if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u);
          }
        } catch { }
      }

      function pickNRandom(n) {
        const pool = names.slice();
        const picks = [];
        for (let i = 0; i < n && pool.length; i++) {
          const idx = Math.floor(Math.random() * pool.length);
          picks.push({ name: pool[idx], idx: names.indexOf(pool[idx]) });
          pool.splice(idx, 1);
        }
        return picks;
      }

      function startCinemaDraw() {
        unlockAudio();

        if (names.length < 1) {
          showToast("Lista vazia.", "Adicione nomes antes de sortear.");
          return;
        }

        const cfg = readConfig();
        const total = 1;
        const countFrom = Number(cfg.count) || 5;

        openOverlay();
        startRolling();

        fireTracers();
        whoosh(0.45);
        setPhase("PREP");
        subline.textContent = "Carregando alvo‚Ä¶";

        flowTimer = setTimeout(() => {
          setPhase("COUNTDOWN");
          subline.textContent = "Contagem regressiva em curso‚Ä¶";

          let c = countFrom;
          countEl.textContent = c;
          fill.style.width = "0%";

          countdown = setInterval(() => {
            if (cfg.sound) tickBeep(c);
            c--;
            countEl.textContent = c;
            const progress = ((countFrom - c) / countFrom) * 100;
            fill.style.width = Math.min(100, progress) + "%";

            if (c <= 0) {
              clearInterval(countdown); countdown = null;

              setPhase("HOLD");
              subline.textContent = "Travando mira‚Ä¶";
              stopRolling();
              if (cfg.sound) holdHit();

              const picks = pickNRandom(total);
              pendingWinner = picks[0] || null;

              flowTimer = setTimeout(() => {
                setPhase("REVEAL");
                subline.textContent = "ALVO DEFINIDO ‚Ä¢ VENCEDOR DO SORTEIO";

                rollingEl.style.display = "none";
                finalWinnerEl.style.display = "block";
                fill.style.width = '100%';

                finalWinnerEl.innerHTML = '';
                const wrap = document.createElement('div'); wrap.className = 'revealWrap';
                picks.forEach((p) => {
                  const it = document.createElement('div');
                  it.className = 'revealItem';
                  it.textContent = p.name;
                  wrap.appendChild(it);
                });
                finalWinnerEl.appendChild(wrap);

                let delay = 0;
                const stagger = (cfg.stagger && Number(cfg.stagger)) ? Number(cfg.stagger) : 800;

                picks.forEach((p, i) => {
                  setTimeout(() => {
                    const item = wrap.children[i];
                    item.classList.add('show');

                    if (cfg.sound) {
                      if (i === 0) revealHit(); else whoosh(0.18);
                    }
                    flashBang();
                    shake();
                    fireTracers();

                    if (cfg.sound) speak('Vencedor: ' + p.name);
                    if (i === 0) pendingWinner = p;
                    if (i === picks.length - 1) setPhase('CONFIRM');
                  }, delay);
                  delay += stagger;
                });

              }, 900);
            }
          }, 1000);
        }, 400);
      }

      function confirmWinner() {
        unlockAudio();

        let selected = [];
        if (pendingWinner) selected = [pendingWinner];

        if (!selected.length) { showToast("Nenhum vencedor pendente.", "Clique em SORTEAR."); return; }

        const added = [];
        for (const s of selected) {
          const w = { name: s.name, whenISO: nowISO(), prize: norm(prize.value) || "‚Äî" };
          winners.unshift(w);
          added.push(w.name);
          const idx = names.findIndex(n => n === s.name);
          if (idx >= 0) names.splice(idx, 1);
        }

        lastUndo = added[0] ? { name: added[0], whenISO: nowISO(), prize: norm(prize.value) || '‚Äî' } : null;
        pendingWinner = null;
        persist(); render();
        showToast("Vencedor confirmado!", added.join(', '));
        closeOverlay();
      }

      // Export/Import JSON handlers
      $("btnExportJson").addEventListener('click', () => {
        const payload = { names, winners, prize: prize.value };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'rover_raffle_export.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 800);
        showToast('Exportado JSON', 'Arquivo baixado');
      });

      const jsonInput = $("jsonInput");
      jsonInput.addEventListener('change', async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (Array.isArray(data.names)) names = data.names.slice();
          if (Array.isArray(data.winners)) winners = data.winners.slice();
          prize.value = data.prize || '';
          persist(); render();
          showToast('Importado JSON', 'Dados carregados');
        } catch (err) {
          showToast('Erro ao importar JSON', String(err));
        }
        jsonInput.value = '';
      });

      $("btnImportJson")?.addEventListener('click', () => { jsonInput.click(); });

      $("btnDraw").addEventListener("click", startCinemaDraw);
      $("btnConfirm").addEventListener("click", confirmWinner);
      $("btnCloseOverlay").addEventListener("click", closeOverlay);

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeOverlay();
      });

      $("btnUndo").addEventListener("click", () => {
        unlockAudio();
        if (!winners.length) { showToast("Nada para desfazer."); return; }
        const removed = winners.shift();
        names.push(removed.name);
        lastUndo = null;
        persist(); render();
        showToast("Desfeito.", removed.name + " voltou para a lista");
      });

      $("btnClearHistory").addEventListener("click", () => {
        winners = [];
        lastUndo = null;
        persist(); render();
        showToast("Hist√≥rico limpo.");
      });

      $("btnExport").addEventListener("click", () => {
        unlockAudio();
        if (!winners.length) { showToast("Sem vencedores para exportar."); return; }
        const lines = ["posicao;nome;premio;data_hora"];
        winners.forEach((w, i) =>
          lines.push(`${i + 1};"${w.name.replaceAll('"', '""')}";"${w.prize}";"${formatBR(w.whenISO)}"`)
        );
        const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "vencedores_rover_em_guerra.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 800);
        showToast("Exportado.", "Arquivo CSV baixado.");
      });

      $("btnReset").addEventListener("click", () => {
        unlockAudio();
        const ok = confirm("Zerar tudo?\n\nIsso apaga lista, hist√≥rico e configura√ß√µes deste navegador.");
        if (!ok) return;
        names = []; winners = []; lastUndo = null; pendingWinner = null;
        localStorage.removeItem(KEY);
        closeOverlay();
        applyStageMode(true);
        render();
        showToast("Tudo zerado.");
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (overlay.style.display === "flex") closeOverlay();
          const modal = document.getElementById('settingsModal');
          if (modal?.getAttribute('aria-hidden') === 'false') {
            modal.setAttribute('aria-hidden', 'true');
            document.getElementById('btnSettings')?.focus();
          }
        }
        if (e.key === "Enter" && overlay.style.display === "flex") { e.preventDefault(); confirmWinner(); }
        if (e.key === " ") {
          const tag = document.activeElement?.tagName?.toLowerCase();
          if (tag === "input" || tag === "textarea" || tag === "select" || tag === "button") return;
          e.preventDefault();
          startCinemaDraw();
        }
      });

      // Logo upload
      logoBox.addEventListener("click", () => { unlockAudio(); logoInput.click(); });
      logoInput.addEventListener("change", (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        unlockAudio();
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          logoImg.src = dataUrl;
          logoImg.style.display = "block";
          logoText.style.display = "none";
          try {
            const raw = localStorage.getItem(KEY);
            const data = raw ? JSON.parse(raw) : { names, winners, prize: prize.value };
            data.logo = dataUrl;
            data.cfg = { count: 5, sound: true, theme: 'gold', stagger: 800, volume: 100, stage: true };
            localStorage.setItem(KEY, JSON.stringify(data));
          } catch { }
          showToast("Logo aplicada.");
        };
        reader.readAsDataURL(file);
        e.target.value = "";
      });

      // initial
      restore();
      applyStageMode(true);
      persist();
      render();
      renderGroupsUI();

      window.addEventListener("pointerdown", unlockAudio, { once: true });
    })();

    // --- Extra UI wiring: Settings modal and spotlight actions ---
    (function () {
      const KEY = 'rover_war_cinema_raffle_v1';

      const modal = document.getElementById('settingsModal');
      const btnSettings = document.getElementById('btnSettings');
      const btnCloseSettings = document.getElementById('btnCloseSettings');
      const btnCancelSettings = document.getElementById('btnCancelSettings');
      const btnSaveSettings = document.getElementById('btnSaveSettings');
      const cfgCount = document.getElementById('cfgCount');
      const cfgSound = document.getElementById('cfgSound');
      const cfgTheme = document.getElementById('cfgTheme');
      const cfgStageSwitch = document.getElementById('cfgStageSwitch');
      const cfgVolume = document.getElementById('cfgVolume');

      const focusableSel = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"]), [role="switch"]';

      function setSwitch(on) {
        cfgStageSwitch.classList.toggle('on', !!on);
        cfgStageSwitch.setAttribute('aria-checked', on ? 'true' : 'false');
      }

      function forceLockedStageAndVolume() {
        setSwitch(true);

        if (cfgVolume) {
          cfgVolume.value = 100;
          cfgVolume.setAttribute('disabled', 'disabled');
          cfgVolume.style.opacity = '0.6';
          cfgVolume.title = 'Volume travado em 100%';
        }

        cfgStageSwitch?.classList.add('on');
        cfgStageSwitch?.setAttribute('aria-checked', 'true');
        cfgStageSwitch?.setAttribute('aria-disabled', 'true');
        cfgStageSwitch.style.pointerEvents = 'none';
        cfgStageSwitch.style.opacity = '0.6';
      }

      function openModal() {
        modal.setAttribute('aria-hidden', 'false');
        forceLockedStageAndVolume();
        const first = modal.querySelector(focusableSel);
        first?.focus();
      }

      function closeModal() {
        modal.setAttribute('aria-hidden', 'true');
        btnSettings?.focus();
      }

      btnSettings?.addEventListener('click', openModal);
      btnCloseSettings?.addEventListener('click', closeModal);
      btnCancelSettings?.addEventListener('click', closeModal);

      modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });

      modal?.addEventListener('keydown', (e) => {
        if (e.key !== 'Tab') return;
        const focusables = Array.from(modal.querySelectorAll(focusableSel)).filter(el => !el.hasAttribute('disabled'));
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      });

      cfgStageSwitch?.addEventListener('click', (e) => e.preventDefault());
      cfgStageSwitch?.addEventListener('keydown', (e) => e.preventDefault());

      btnSaveSettings?.addEventListener('click', () => {
        try {
          const raw = localStorage.getItem(KEY);
          const data = raw ? JSON.parse(raw) : {};
          const stagger = Number(document.getElementById('cfgStagger')?.value || 800);

          const volume = 100;
          const stage = true;

          data.cfg = {
            count: Number(cfgCount.value) || 5,
            sound: cfgSound.value === '1',
            theme: cfgTheme.value,
            stagger,
            volume,
            stage
          };

          localStorage.setItem(KEY, JSON.stringify(data));

          try {
            if (window.master && typeof window.master.gain !== 'undefined') {
              window.master.gain.value = 1;
            }
          } catch { }

          document.body.classList.add('stage');
        } catch { }
        closeModal();
      });

      btnSettings?.addEventListener('click', () => {
        try {
          const raw = localStorage.getItem(KEY);
          const data = raw ? JSON.parse(raw) : {};
          const cfg = data.cfg || {};
          if (cfg.count) cfgCount.value = cfg.count;
          cfgSound.value = cfg.sound ? '1' : '0';
          cfgTheme.value = cfg.theme || 'gold';
          if (cfg.stagger) document.getElementById('cfgStagger').value = cfg.stagger;
          forceLockedStageAndVolume();
        } catch { }
      });

      const btnRepeat = document.getElementById('btnRepeat');
      const btnAnnounce = document.getElementById('btnAnnounce');

      btnRepeat?.addEventListener('click', () => {
        window.dispatchEvent(new Event('pointerdown'));
        try { window.__tone && window.__tone(660, 0.08, 'sine', 0.08); } catch { }
      });

      btnAnnounce?.addEventListener('click', () => {
        const txt = document.getElementById('lastWinner')?.textContent || '';
        if (txt && txt.trim() !== '‚Äî') alert('Vencedor: ' + txt);
      });

      forceLockedStageAndVolume();
      document.body.classList.add('stage');
      try { if (window.master && window.master.gain) window.master.gain.value = 1; } catch { }

    })();
  </script>
</body>

</html>